
#!/bin/sh
system_type=$(uname -s)

if [ "$system_type" = "Linux" ]; then
  echo "[Step] Updating base packages for Linux"
  sudo apt update && \
  sudo apt install -y zsh git curl wget ca-certificates gnupg build-essential locales unzip tar gzip && \
  sudo locale-gen ja_JP.UTF-8 && \
  chsh -s $(which zsh)
fi

# Homebrew installation
if ! command -v brew >/dev/null 2>&1; then
  echo "[Step] Installing Homebrew"
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Add brew to PATH
if [ "$system_type" = "Darwin" ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
  echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
else
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
  echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.zshrc
fi

# Bundle Brewfile
REPO=$(yadm rev-parse --show-toplevel)
cd "$REPO" || exit 1

if [ -f "$REPO/Brewfile" ]; then
  echo "[Step] Running brew bundle"
  brew bundle --file "$REPO/Brewfile"
else
  echo "[Info] No Brewfile found at $REPO"
fi

